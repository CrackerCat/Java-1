# CVE-2021-45456 Apache Kylin 命令注入

>看着y4er师傅写的分析，第一次看有点懵逼，所以简单的补充一下。

## 补充分析

首先漏洞点在该路由的 **dumpProjectDiagnosisInfo**方法中project可控。

![image-20220114222208845](https://user-images.githubusercontent.com/63966847/149534592-9f600b83-9036-45f3-a9a9-c7bc2bae5e48.png)


跟着进去，可以看到**runDiagnosisCLI**方法之后正常执行命令并且project一直可控。所以非常有机会RCE了!

![image-20220114222316611](https://user-images.githubusercontent.com/63966847/149534609-f5d94546-4965-4580-8d1f-bfcb054127c3.png)


唯一绕过就是不让 **projectInstance**为null，不然就throw抛异常。所以我们看看projectInstance得到如何获得。

首先通过 **convertStringToBeAlphanumericUnderscore**方法进行替换，输入 **touch 123**则替换之后就为 **touch123**

![image-20220114222541519](https://user-images.githubusercontent.com/63966847/149534631-abb945b7-2bce-4fbe-baa3-e7032f013124.png)


之后通过 **getProject**方法去找有没有 **touch123**这个项目。看下面是通过**projectMap.get(projectName);**去获得如果有就不会抛异常就成功命令执行。

![image-20220114222809923](https://user-images.githubusercontent.com/63966847/149534653-e78ad090-416d-4ce6-ae15-1fed7012cbea.png)



所以我们在看看得到才什么类中获取，也就是去看 **projectMap**是指的那个类。

![image-20220114222920990](https://user-images.githubusercontent.com/63966847/149534679-31cc4590-a299-4882-9bee-b8fd9789b776.png)



然后跟上ProjectInstance，则到了如下代码，可以看到setname进去，所以我们最开始需要setname进去和 **touch123**相同就可以了


![image-20220114223024834](https://user-images.githubusercontent.com/63966847/149534692-aacfd561-fcc5-42ae-94c0-84c342f026be.png)


向上跟踪

![image-20220114223153636](https://user-images.githubusercontent.com/63966847/149534717-bb589da3-01f3-4f5b-a81b-b62e23419bc9.png)


然后去跟踪 **createProject**方法，之后到了 **saveProject**方法

![image-20220114223350119](https://user-images.githubusercontent.com/63966847/149534727-a5264b5f-6dce-496d-bccd-90e6e0b4e392.png)


可以看到传递的是json格式然后去获得name，并且通过isAlphanumericUnderscore判断了，但是如果执行命令肯定set进去的name是 **tuoch123**，巧的是 **tuoch123**刚刚好去绕过。

![image-20220114223924151](https://user-images.githubusercontent.com/63966847/149534845-842825f1-95ee-4028-a70c-d7d63f9651d2.png)



![image-20220114223911294](https://user-images.githubusercontent.com/63966847/149534827-4f56fa4c-6fb9-4a8f-bfd3-2b798e8ab042.png)


从而成功执行命令。

## 演示

y4er师傅的图

先创建项目名

![image-20220114224040087](https://user-images.githubusercontent.com/63966847/149534861-95093753-4e7f-4b8d-a552-7218ac5ce038.png)


执行命令

![image-20220114224119476](https://user-images.githubusercontent.com/63966847/149534871-c0d29304-c9ca-43b5-b2ac-6abae59abe52.png)


## 修复

![image-20220114224356250](https://user-images.githubusercontent.com/63966847/149534884-ff61e395-b5bc-4c97-94a3-3f07b3105f53.png)


传入cmd的参数改为projectName而非http传入的project，projectName经过convertStringToBeAlphanumericUnderscore() 处理，所以无法输入非字母数字下划线的字符来触发命令执行。

(除非单个命令可以创成严重危害。。。。。

